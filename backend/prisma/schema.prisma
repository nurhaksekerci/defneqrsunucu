// Prisma Schema - QR Menü ve Restoran Yönetim Sistemi

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Kullanıcı Rolleri
enum UserRole {
  ADMIN              // Sistem geliştiricileri
  STAFF              // Sistem çalışanları
  RESTAURANT_OWNER   // Restoran sahibi
  CASHIER            // Kasiyer
  WAITER             // Garson
  BARISTA            // Barista
  COOK               // Aşçı
}

// Sipariş Durumları
enum OrderStatus {
  PENDING      // Beklemede
  PREPARING    // Hazırlanıyor
  READY        // Hazır
  DELIVERED    // Teslim Edildi
  CANCELLED    // İptal Edildi
}

// Ödeme Durumları
enum PaymentStatus {
  UNPAID       // Ödenmedi
  PARTIAL      // Kısmi Ödendi
  PAID         // Tamamen Ödendi
}

// Ödeme Yöntemleri
enum PaymentMethod {
  CASH         // Nakit
  CREDIT_CARD  // Kredi Kartı
  DEBIT_CARD   // Banka Kartı
}

// Kullanıcılar Tablosu
model User {
  id            String         @id @default(uuid())
  username      String?        @unique
  email         String         @unique
  password      String?        // OAuth kullanıcıları için null olabilir
  fullName      String
  role          UserRole       @default(RESTAURANT_OWNER)
  
  // OAuth
  googleId      String?        @unique
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  restaurants      Restaurant[]      @relation("RestaurantOwner")
  orders           Order[]           @relation("WaiterOrders")
  payments         Payment[]         @relation("CashierPayments")
  subscriptions    Subscription[]
  passwordResets   PasswordReset[]
  refreshTokens    RefreshToken[]
  promoCodeUsages  PromoCodeUsage[]
  affiliatePartner AffiliatePartner?
  referrals        Referral[]
  supportTickets   SupportTicket[]
  assignedTickets  SupportTicket[]  @relation("AssignedTickets")
  resolvedTickets SupportTicket[]  @relation("ResolvedTickets")
  ticketMessages   TicketMessage[]  @relation("TicketMessages")

  @@index([role])
  @@index([isDeleted])
  @@index([createdAt])
  @@index([email, isDeleted])
  @@map("users")
}

// Restoranlar Tablosu
model Restaurant {
  id            String         @id @default(uuid())
  name          String
  slug          String         @unique  // Türkçe karakter destekli, otomatik oluşturulur
  description   String?
  address       String?
  phone         String?
  logo          String?        // Logo URL
  
  // Menü Özelleştirme Ayarları
  menuSettings  Json?          // { primaryColor, backgroundColor, viewType, showHeader, showFooter, itemsPerRow }
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  ownerId       String
  owner         User           @relation("RestaurantOwner", fields: [ownerId], references: [id])
  
  categories    Category[]
  products      Product[]
  orders        Order[]
  payments      Payment[]
  stocks        Stock[]
  menuScans     MenuScan[]
  tables        Table[]
  supportTickets SupportTicket[]

  @@index([ownerId])
  @@index([isDeleted])
  @@index([createdAt])
  @@index([slug, isDeleted])
  @@map("restaurants")
}

// Kategoriler Tablosu (Global ve Restoran Özel)
model Category {
  id            String         @id @default(uuid())
  name          String
  description   String?
  image         String?
  order         Int            @default(0)  // Sıralama için
  
  // Global veya Restoran Özel
  isGlobal      Boolean        @default(false)
  restaurantId  String?
  restaurant    Restaurant?    @relation(fields: [restaurantId], references: [id])
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  products      Product[]
  
  @@index([restaurantId])
  @@index([isGlobal])
  @@index([isDeleted])
  @@index([order])
  @@index([restaurantId, isDeleted, isGlobal])
  @@map("categories")
}

// Ürünler Tablosu (Global ve Restoran Özel)
model Product {
  id            String         @id @default(uuid())
  name          String
  description   String?
  image         String?
  basePrice     Decimal?       @db.Decimal(10, 2)  // Opsiyonel: Global ürünler için null, restoran ürünleri için zorunlu
  order         Int            @default(0)  // Sıralama için
  
  // Global veya Restoran Özel
  isGlobal      Boolean        @default(false)
  isActive      Boolean        @default(true)      // Ürün menüde gösterilsin mi?
  restaurantId  String?
  restaurant    Restaurant?    @relation(fields: [restaurantId], references: [id])
  
  categoryId    String
  category      Category       @relation(fields: [categoryId], references: [id])
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  stocks        Stock[]
  orderItems    OrderItem[]
  
  @@index([categoryId])
  @@index([restaurantId])
  @@index([isGlobal])
  @@index([isActive])
  @@index([isDeleted])
  @@index([order])
  @@index([restaurantId, categoryId, isDeleted])
  @@index([isGlobal, isActive, isDeleted])
  @@map("products")
}

// Stok Tablosu (Restoran Özel)
model Stock {
  id            String         @id @default(uuid())
  quantity      Int            @default(0)
  price         Decimal        @db.Decimal(10, 2)  // Restoran özel fiyat
  minStock      Int            @default(0)         // Minimum stok seviyesi
  
  restaurantId  String
  restaurant    Restaurant     @relation(fields: [restaurantId], references: [id])
  
  productId     String
  product       Product        @relation(fields: [productId], references: [id])
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  @@unique([restaurantId, productId])
  @@index([restaurantId])
  @@index([productId])
  @@index([isDeleted])
  @@index([quantity])
  @@map("stocks")
}

// Siparişler Tablosu
model Order {
  id            String         @id @default(uuid())
  orderNumber   String         @unique  // Sipariş numarası
  tableNumber   String?        // Masa numarası (eski)
  status        OrderStatus    @default(PENDING)
  notes         String?        // Özel notlar
  
  restaurantId  String
  restaurant    Restaurant     @relation(fields: [restaurantId], references: [id])
  
  tableId       String?
  table         Table?         @relation(fields: [tableId], references: [id])
  
  waiterId      String?
  waiter        User?          @relation("WaiterOrders", fields: [waiterId], references: [id])
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  orderItems    OrderItem[]
  payments      Payment[]
  
  @@index([restaurantId])
  @@index([tableId])
  @@index([waiterId])
  @@index([status])
  @@index([isDeleted])
  @@index([createdAt])
  @@index([restaurantId, status, isDeleted])
  @@index([tableId, status])
  @@map("orders")
}

// Sipariş Detayları
model OrderItem {
  id            String         @id @default(uuid())
  quantity      Int
  unitPrice     Decimal        @db.Decimal(10, 2)
  totalPrice    Decimal        @db.Decimal(10, 2)
  notes         String?        // Ürün özel notlar
  
  orderId       String
  order         Order          @relation(fields: [orderId], references: [id])
  
  productId     String
  product       Product        @relation(fields: [productId], references: [id])
  
  // Audit
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("order_items")
}

// Ödemeler Tablosu
model Payment {
  id            String         @id @default(uuid())
  amount        Decimal        @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus  @default(UNPAID)
  
  orderId       String
  order         Order          @relation(fields: [orderId], references: [id])
  
  restaurantId  String
  restaurant    Restaurant     @relation(fields: [restaurantId], references: [id])
  
  cashierId     String?
  cashier       User?          @relation("CashierPayments", fields: [cashierId], references: [id])
  
  // Soft Delete & Audit
  isDeleted     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  
  @@index([restaurantId])
  @@index([orderId])
  @@index([status])
  @@index([isDeleted])
  @@index([createdAt])
  @@index([restaurantId, status, isDeleted])
  @@map("payments")
}

// Sistem Ayarları Tablosu
model SystemSettings {
  id                    String   @id @default(uuid())
  
  // Genel Ayarlar
  siteName              String   @default("Defne Qr")
  siteDescription       String   @default("QR Menü ve Restoran Yönetim Sistemi")
  supportEmail          String   @default("destek@defneqr.com")
  
  // Kullanıcı Ayarları
  maxRestaurantsPerUser Int      @default(5)
  
  // Kimlik Doğrulama
  enableGoogleAuth      Boolean  @default(false)
  
  // Sistem Durumu
  maintenanceMode       Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("system_settings")
}

// QR Menü Taramaları
model MenuScan {
  id            String      @id @default(uuid())
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  
  // Tarama zamanı
  scannedAt     DateTime    @default(now())
  
  // İsteğe bağlı: IP, user agent gibi bilgiler
  ipAddress     String?
  userAgent     String?
  
  @@map("menu_scans")
  @@index([restaurantId, scannedAt])
}

// Masalar Tablosu
model Table {
  id            String      @id @default(uuid())
  name          String      // Örn: A1, A2, B5
  restaurantId  String
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])
  
  // Masa durumu
  isOccupied    Boolean     @default(false)
  
  // Soft Delete & Audit
  isDeleted     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?
  
  // İlişkiler
  orders        Order[]
  
  @@map("tables")
  @@unique([restaurantId, name])
  @@index([restaurantId])
}

// Plan Tipleri
enum PlanType {
  FREE       // Ücretsiz
  PREMIUM    // Premium
  CUSTOM     // Kurumsal
}

// Abonelik Durumları
enum SubscriptionStatus {
  ACTIVE     // Aktif
  EXPIRED    // Süresi Dolmuş
  CANCELLED  // İptal Edilmiş
}

// Planlar Tablosu
model Plan {
  id                    String   @id @default(uuid())
  name                  String   @unique
  type                  PlanType
  price                 Float    @default(0)
  duration              Int      @default(365) // Gün cinsinden süre
  
  // Limitler
  maxRestaurants        Int      @default(1)
  maxCategories         Int      @default(5)
  maxProducts           Int      @default(20)
  
  // Özellikler
  canRemoveBranding     Boolean  @default(false)
  hasGlobalCatalog      Boolean  @default(true)
  hasDetailedReports    Boolean  @default(true)
  
  // Popülerlik ve Ek Ücretler
  isPopular             Boolean  @default(false) // Popüler plan mi?
  extraRestaurantPrice  Float    @default(0)     // Ek işletme başına ücret
  
  // Açıklama
  description           String?
  features              Json?    // Plan özellikleri (JSON array)
  
  // Durum
  isActive              Boolean  @default(true)
  
  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // İlişkiler
  subscriptions         Subscription[]
  
  @@map("plans")
}

// Abonelikler Tablosu
model Subscription {
  id            String              @id @default(uuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id])
  planId        String
  plan          Plan                @relation(fields: [planId], references: [id])
  
  // Abonelik bilgileri
  startDate     DateTime            @default(now())
  endDate       DateTime
  status        SubscriptionStatus  @default(ACTIVE)
  
  // Ödeme bilgileri
  amount        Float
  paymentDate   DateTime?
  
  // Custom plan için
  customRestaurantCount Int?  // Kurumsal planda işletme sayısı
  
  // Audit
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  cancelledAt   DateTime?
  
  // İlişkiler
  promoCodeUsages PromoCodeUsage[]
  
  @@map("subscriptions")
  @@index([userId])
  @@index([planId])
  @@index([status])
}

// Şifre Sıfırlama Tokenleri
model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@map("password_resets")
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Refresh Tokenlar
model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  expiresAt  DateTime
  isRevoked  Boolean  @default(false)
  revokedAt  DateTime?
  createdAt  DateTime @default(now())
  
  // Device/Browser tracking için opsiyonel
  userAgent  String?
  ipAddress  String?
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isRevoked])
}

// Token Blacklist (Revoked access tokens)
model TokenBlacklist {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  reason    String?  // logout, security, etc.
  createdAt DateTime @default(now())
  
  @@map("token_blacklist")
  @@index([token])
  @@index([expiresAt])
}

// Promosyon Kodları
enum PromoCodeType {
  PERCENTAGE  // Yüzde indirim
  FIXED       // Sabit tutar indirim
  FREE_TRIAL  // Ücretsiz deneme süresi
}

model PromoCode {
  id            String        @id @default(uuid())
  code          String        @unique
  type          PromoCodeType
  
  // İndirim değeri
  discountValue Float         // Yüzde veya sabit tutar
  
  // Kullanım limitleri
  maxUses       Int?          // Maksimum kullanım sayısı (null = sınırsız)
  usedCount     Int           @default(0)
  
  // Geçerlilik
  validFrom     DateTime      @default(now())
  validUntil    DateTime?     // null = süresiz
  
  // Uygulanabilir planlar (null = tüm planlar)
  applicablePlans Json?       // ["plan-id-1", "plan-id-2"]
  
  // Durum
  isActive      Boolean       @default(true)
  
  // Açıklama
  description   String?
  
  // Audit
  createdBy     String?       // Admin user ID
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // İlişkiler
  usages        PromoCodeUsage[]
  
  @@map("promo_codes")
  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
}

// Promosyon Kodu Kullanımları
model PromoCodeUsage {
  id            String    @id @default(uuid())
  promoCodeId   String
  promoCode     PromoCode @relation(fields: [promoCodeId], references: [id])
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  
  // İndirim detayları
  discountAmount Float
  originalAmount Float
  finalAmount    Float
  
  usedAt        DateTime  @default(now())
  
  @@map("promo_code_usages")
  @@index([promoCodeId])
  @@index([userId])
  @@index([subscriptionId])
  @@index([usedAt])
}

// Affiliate Partner Durumları
enum AffiliateStatus {
  PENDING   // Onay bekliyor
  ACTIVE    // Aktif
  SUSPENDED // Askıya alınmış
  BANNED    // Yasaklanmış
}

// Affiliate Partners (Referans Partnerleri)
model AffiliatePartner {
  id                String          @id @default(uuid())
  userId            String          @unique
  user              User            @relation(fields: [userId], references: [id])
  
  // Referral Code (benzersiz)
  referralCode      String          @unique
  
  // İstatistikler
  totalReferrals    Int             @default(0)
  totalEarnings     Float           @default(0)
  pendingEarnings   Float           @default(0)
  paidEarnings      Float           @default(0)
  
  // Durum
  status            AffiliateStatus @default(PENDING)
  
  // Banka bilgileri (ödeme için)
  bankName          String?
  accountHolder     String?
  iban              String?
  
  // Audit
  approvedBy        String?         // Admin user ID
  approvedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // İlişkiler
  referrals         Referral[]
  commissions       AffiliateCommission[]
  payouts           AffiliatePayout[]
  
  @@map("affiliate_partners")
  @@index([userId])
  @@index([referralCode])
  @@index([status])
}

// Referanslar (Affiliate ile kayıt olan kullanıcılar)
model Referral {
  id                String           @id @default(uuid())
  affiliateId       String
  affiliate         AffiliatePartner @relation(fields: [affiliateId], references: [id])
  
  referredUserId    String
  referredUser      User             @relation(fields: [referredUserId], references: [id])
  
  // Referral bilgileri
  ipAddress         String?
  userAgent         String?
  
  // Conversion tracking
  hasSubscribed     Boolean          @default(false)
  firstSubscription DateTime?
  
  // Ücretsiz plan: admin onayı bekliyor; ücretli plan: otomatik ödül
  pendingDaysApproval Boolean        @default(false)
  daysAwarded       Int?            // Verilen gün sayısı (onaylandığında)
  
  createdAt         DateTime         @default(now())
  
  @@map("referrals")
  @@index([affiliateId])
  @@index([referredUserId])
  @@index([createdAt])
}

// Affiliate Komisyonları
model AffiliateCommission {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliatePartner @relation(fields: [affiliateId], references: [id])
  
  referredUserId  String
  subscriptionId  String
  
  // Komisyon detayları
  amount          Float
  percentage      Float            // Komisyon yüzdesi (kaydedildiği andaki)
  subscriptionAmount Float         // Abonelik tutarı
  
  // Ödeme durumu
  isPaid          Boolean          @default(false)
  paidAt          DateTime?
  payoutId        String?
  
  createdAt       DateTime         @default(now())
  
  @@map("affiliate_commissions")
  @@index([affiliateId])
  @@index([referredUserId])
  @@index([isPaid])
  @@index([createdAt])
}

// Affiliate Ödemeleri
model AffiliatePayout {
  id              String           @id @default(uuid())
  affiliateId     String
  affiliate       AffiliatePartner @relation(fields: [affiliateId], references: [id])
  
  // Ödeme detayları
  amount          Float
  commissionIds   Json             // Hangi komisyonlar ödendi
  
  // Ödeme yöntemi
  method          String           // BANK_TRANSFER, PAYPAL, etc.
  
  // Banka bilgileri (anlık kayıt)
  bankName        String?
  accountHolder   String?
  iban            String?
  
  // İşlem bilgileri
  transactionId   String?
  notes           String?
  
  // Durum
  status          String           @default("PENDING") // PENDING, COMPLETED, FAILED
  
  // Audit
  processedBy     String?          // Admin user ID
  processedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@map("affiliate_payouts")
  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
}

// Destek Talebi Önceliği
enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Destek Talebi Durumu
enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

// Destek Talebi Kategorisi
enum TicketCategory {
  TECHNICAL
  BILLING
  FEATURE_REQUEST
  BUG_REPORT
  GENERAL
}

// Destek Talepleri
model SupportTicket {
  id            String         @id @default(uuid())
  ticketNumber  String         @unique

  userId        String
  user          User           @relation(fields: [userId], references: [id])
  restaurantId  String?
  restaurant    Restaurant?    @relation(fields: [restaurantId], references: [id])

  subject       String
  description   String         @db.Text
  category      TicketCategory
  priority      TicketPriority @default(MEDIUM)
  status        TicketStatus   @default(OPEN)

  assignedToId  String?
  assignedTo    User?          @relation("AssignedTickets", fields: [assignedToId], references: [id])

  resolution    String?        @db.Text
  resolvedAt    DateTime?
  resolvedById  String?
  resolvedBy    User?          @relation("ResolvedTickets", fields: [resolvedById], references: [id])

  rating        Int?           // 1-10, kullanıcı cevabı değerlendirmesi (tek seferlik)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  closedAt      DateTime?

  messages      TicketMessage[]

  @@index([userId])
  @@index([restaurantId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("support_tickets")
}

// Destek Talebi Mesajları
model TicketMessage {
  id          String        @id @default(uuid())
  ticketId    String
  ticket      SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId    String
  author      User           @relation("TicketMessages", fields: [authorId], references: [id])
  isInternal  Boolean        @default(false)

  message     String         @db.Text

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
  @@map("ticket_messages")
}

// Affiliate Ayarları (Sistem geneli)
model AffiliateSettings {
  id                    String   @id @default(uuid())
  
  // Komisyon oranı (%) - Sadece ödenen affiliate'ler için
  commissionRate        Float    @default(10)
  
  // Minimum ödeme tutarı
  minimumPayout         Float    @default(100)
  
  // Restoran sahipleri için gün kazanma sistemi (plan tipine göre)
  daysPerReferral       Int      @default(7)  // Geriye dönük uyumluluk
  daysPerReferralFree   Int      @default(7)  // Ücretsiz plana geçen referral için kazanılan gün
  daysPerReferralPaid   Int      @default(14) // Ücretli plana geçen referral için kazanılan gün
  
  // Özellikler
  isEnabled             Boolean  @default(true)
  requireApproval       Boolean  @default(true) // Affiliate başvuru onayı (referral ödülü plana göre)
  
  // Cookie süresi (gün)
  cookieDuration        Int      @default(30)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("affiliate_settings")
}
